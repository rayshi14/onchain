{% extends "abi/base_search_template.html" %}

{% block title %}ChainKlik - View Abi{% endblock %}

{% block content %}
<script>
$(document).ready(function () {
    $('#edit-button').on('click', function(){
        window.location.href = window.location.href + "/edit";
    });
  
    $('#query-button').on('click', function(){
        const inputs_json = JSON.parse('{{ abi.abi.inputs|escapejs }}'.replace(/'/g, '"'));
        var params = {};
        inputs_json.forEach((input) => {
            params[input["name"]] = $("#input-"+input["name"]).val();
        });
        console.log(params);
        var data = {};
                
        data["name"] = "{{abi.name}}";
        data["contract"] = "{{abi.address}}";
        data["params"] = params;
        console.log(data);
        const requestOptions = {
            method: 'POST', // Use the POST method
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data), // Convert data to JSON format
        };
                
        fetch('/abi/api/call_abi', requestOptions)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); // Parse the response JSON if needed
            })
            .then(data => {
                // Handle the response data here (e.g., display it on the page)
                console.log('Response:', data);
                for (var key in data){
                    $("#output-"+key).text(data[key]);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });
});
</script>
<div class="container p-1">
    <div class="card p-d-flex w-100 justify-content-between">
        <div class="card-header d-flex w-100 justify-content-between">
          <h5>{{abi.name}}
              <span class="badge bg-dark mx-1"><a class="list-group-item" href="{{abi.contract_id}}">{{abi.contract}}</a></span>
              {% if abi.type == "function" %}
              <span class="badge bg-info">{{abi.type}}</span>
              {% elif abi.type == "event" %}
              <span class="badge bg-success">{{abi.type}}</span>
              {% else %}
              <span class="badge bg-secondary">{{abi.type}}</span>
              {% endif %}
          </h5>
          <button id="edit-button" type="button" class="btn btn-light">Edit</button>
        </div>
        <div class="card-body">
            <small class="card-subtitle mb-2 text-muted"><a href="https://etherscan.io/address/{{abi.address}}" class="card-link">{{abi.address}}</a></small>
            <p class="card-text">{{abi.desc}}</p>
            {% if abi.type == "contract" %}
                {% for abi in abi.abis %}
                <div class="card m-1">
                    <div class="card-body">
                        <h7 class="card-title fw-bold"><a href="{{abi.id}}">{{abi.name}}</a>
                            {% if abi.type == "function" %}
                            <span class="badge bg-info">{{abi.type}}</span>
                            {% else %}
                            <span class="badge bg-success">{{abi.type}}</span>
                            {% endif %}
                        </h7>
                        <p class="card-text fs-6">{{abi.desc}}</p>
                        <div class="row">
                            {% if abi.abi.inputs|length > 0 %}
                            <div class="card col w-50 m-1">
                                <div class="card-body">
                                    {% if abi.type == "event" %}
                                    <h7 class="card-title">Events</h7>
                                    {% else %}
                                    <h7 class="card-title">Inputs</h7>
                                    {% endif %}
                                    <table class="table table-sm table-striped">
                                      <thead>
                                        <tr>
                                          <th scope="col">Name</th>
                                          <th scope="col">Type</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {% for input in abi.abi.inputs %}
                                        <tr>
                                          <td>{{input.name}}</td>
                                          <td>{{input.type}}</td>
                                        </tr>
                                        {% endfor %}
                                      </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                            {% if abi.abi.outputs|length > 0 %}
                            <div class="card col w-50 m-1">
                                <div class="card-body">
                                    <h7 class="card-title">Outputs</h7>
                                    <table class="table table-sm table-striped">
                                      <thead>
                                        <tr>
                                          <th scope="col">Name</th>
                                          <th scope="col">Type</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {% for output in abi.abi.outputs %}
                                        <tr>
                                          <td>{{output.name}}</td>
                                          <td>{{output.type}}</td>
                                        </tr>
                                        {% endfor %}
                                      </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% elif abi.type == "function" %}
            <div class="row m-1">
                {% if abi.abi.inputs|length > 0 %}
                <div class="card col w-50 m-1">
                    <div class="card-body">
                        <h7 class="card-title">Inputs</h7>
                        <table class="table table-sm table-striped">
                          <thead>
                            <tr>
                              <th scope="col">Name</th>
                              <th scope="col">Type</th>
                              <th scope="col">Value</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for input in abi.abi.inputs %}
                            <tr>
                              <td>{{input.name}}</td>
                              <td>{{input.type}}</td>
                              <td><input id="input-{{input.name}}" type="text" class="form-control" placeholder="{{input.name}} ({{input.type}})"></td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                {% if abi.abi.outputs|length > 0 %}
                <div class="card col w-50 m-1">
                    <div class="card-body">
                        <h7 class="card-title">Outputs</h7>
                        <table class="table table-sm table-striped">
                          <thead>
                            <tr>
                              <th scope="col">Name</th>
                              <th scope="col">Type</th>
                              <th scope="col">Value</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for output in abi.abi.outputs %}
                            <tr>
                              <td>{{output.name}}</td>
                              <td>{{output.type}}</td>
                              <td id="output-{{output.name}}"></td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="row m-1"><button id="query-button" type="button" class="btn btn-dark btn-sm col-3 m-auto">Query</button></div>
            {% else %}
            <div class="row m-1">
                {% if abi.abi.inputs|length > 0 %}
                <div class="card col w-50 m-1">
                    <div class="card-body">
                        <h7 class="card-title">Events</h7>
                        <table class="table table-sm table-striped">
                          <thead>
                            <tr>
                              <th scope="col">Name</th>
                              <th scope="col">Type</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for input in abi.abi.inputs %}
                            <tr>
                              <td>{{input.name}}</td>
                              <td>{{input.type}}</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}  
        </div>
    </div>
</div>

{% endblock %}